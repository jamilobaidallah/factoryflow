rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ============================================
    // HELPER FUNCTIONS - Authentication
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isDataOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // HELPER FUNCTIONS - RBAC (Role-Based Access)
    // Note: Storage rules cannot use get() to fetch Firestore docs
    // Role checking is done via Custom Claims or trusted client
    // For now, we rely on data ownership + authentication
    // ============================================

    // ============================================
    // HELPER FUNCTIONS - Validation
    // ============================================

    function isValidImage() {
      return request.resource.contentType.matches('image/.*')
        && request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }

    // ============================================
    // USER STORAGE PATHS
    // ============================================

    match /users/{userId}/{allPaths=**} {
      // Read: Any authenticated data owner can read their files
      allow read: if isDataOwner(userId);

      // Write: Only authenticated data owner can upload valid images
      // Note: RBAC write restrictions are enforced at the application level
      // since Storage rules cannot access Firestore for role lookup
      allow write: if isDataOwner(userId) && isValidImage();
    }

    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
